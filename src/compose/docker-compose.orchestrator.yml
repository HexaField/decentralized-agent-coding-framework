services:
  orchestrator:
    image: mvp-orchestrator:${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: docker/orchestrator.Dockerfile
    container_name: mvp-orchestrator
    environment:
      - ORCHESTRATOR_TOKEN=${ORCHESTRATOR_TOKEN}
      - DASHBOARD_TOKEN=${DASHBOARD_TOKEN}
      - ORCHESTRATOR_CONFIG=/app/configs/orchestrator.example.yaml
    volumes:
      - ../orchestrator/configs:/app/configs:ro
      - ../state:/state
  - ../scripts:/scripts:ro
  - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "0.0.0.0:18080:8080"
    networks:
      - mvp

  dashboard:
    image: node:20-alpine
    working_dir: /app
  command: ["sh", "-lc", "npm install --omit=dev && npx tsx server/server.ts"]
    environment:
      - DASHBOARD_TOKEN=${DASHBOARD_TOKEN}
      - ORCHESTRATOR_URL=http://mvp-orchestrator:8080
      - ORCHESTRATOR_TOKEN=${ORCHESTRATOR_TOKEN}
    volumes:
      - ../dashboard:/app
      - ../state:/state
  # no direct cluster control from dashboard in dev anymore
    ports:
      - "127.0.0.1:8090:8090"
    networks:
      - mvp

networks:
  mvp:
    driver: bridge
