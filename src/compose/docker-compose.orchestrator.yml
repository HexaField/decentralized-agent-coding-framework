version: "3.8"
services:
  orchestrator:
    image: mvp-orchestrator:${IMAGE_TAG:-latest}
    build:
      context: ..
      dockerfile: docker/orchestrator.Dockerfile
    container_name: mvp-orchestrator
    environment:
      ORCHESTRATOR_TOKEN: ${ORCHESTRATOR_TOKEN}
      DASHBOARD_TOKEN: ${DASHBOARD_TOKEN}
      ORCHESTRATOR_CONFIG: /app/configs/orchestrator.example.yaml
      WORKSPACE_DIR: /workspace
    volumes:
      - ../orchestrator/configs:/app/configs:ro
      - ../state:/state
      - ../:/workspace:ro
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "18080:8080"
    networks:
      - mvp

  dashboard:
    image: node:20-alpine
    working_dir: /app
    command: ["sh", "-lc", "npm ci && npx tsx server/server.ts"]
    environment:
      DASHBOARD_TOKEN: ${DASHBOARD_TOKEN}
      ORCHESTRATOR_URL: http://mvp-orchestrator:8080
      ORCHESTRATOR_TOKEN: ${ORCHESTRATOR_TOKEN}
      UI_DEV: "0"
      LOCAL_ENSURE: "0"
    volumes:
      - ../dashboard:/app
      - ../state:/state
    ports:
      - "8090:8090"
    networks:
      - mvp

networks:
  mvp:
    driver: bridge
